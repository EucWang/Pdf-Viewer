name: Close Fixed Issues

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  close-fixed-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh jq

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Close stale Fixed issues
        run: |
          echo "Checking for Fixed issues inactive for 30+ days..."
          gh issue list --label "Fixed" --state open --limit 100 --json number,updatedAt \
          | jq -c '.[] | select((now - ( .updatedAt | fromdateiso8601 )) > (60*60*24*30))' \
          | while read -r issue; do
              issue_number=$(echo "$issue" | jq '.number')
              echo "Closing issue #$issue_number"
              gh issue close "$issue_number" --comment "This issue is marked **Fixed** and has had no activity for 30+ days. Closing it now. Feel free to reopen if needed. âœ…"
            done
